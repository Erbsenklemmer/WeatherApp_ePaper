#include "ESP8266WiFi.h"
#include "core_esp8266_features.h"
#include "GlobalSettings.h"

#include "JsonStreamingParser.h"
#include "WifiParser.h"

uint lastTime = millis();
unsigned long timerDelay = 10000;
unsigned int availableRemainingCounter = 0;

//#define __TEST__

#if defined __TEST__
  const char* testResponse = "{\"lat\":48.81,\"lon\":9.38,\"timezone\":\"Europe/Berlin\",\"timezone_offset\":3600,\"current\":{\"dt\":1703019941,\"sunrise\":1702969900,\"sunset\":1702999624,\"temp\":4.36,\"feels_like\":4.36,\"pressure\":1019,\"humidity\":81,\"dew_point\":1.39,\"uvi\":0,\"clouds\":75,\"visibility\":10000,\"wind_speed\":1.03,\"wind_deg\":0,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"rain\":{\"1h\":0.32}},\"minutely\":[{\"dt\":1703019960,\"precipitation\":0.316},{\"dt\":1703020020,\"precipitation\":0.316},{\"dt\":1703020080,\"precipitation\":0.316},{\"dt\":1703020140,\"precipitation\":0.316},{\"dt\":1703020200,\"precipitation\":0.316},{\"dt\":1703020260,\"precipitation\":0.2938},{\"dt\":1703020320,\"precipitation\":0.2716},{\"dt\":1703020380,\"precipitation\":0.2494},{\"dt\":1703020440,\"precipitation\":0.2272},{\"dt\":1703020500,\"precipitation\":0.205},{\"dt\":1703020560,\"precipitation\":0.1948},{\"dt\":1703020620,\"precipitation\":0.1846},{\"dt\":1703020680,\"precipitation\":0.1744},{\"dt\":1703020740,\"precipitation\":0.1642},{\"dt\":1703020800,\"precipitation\":0.154},{\"dt\":1703020860,\"precipitation\":0.1864},{\"dt\":1703020920,\"precipitation\":0.2188},{\"dt\":1703020980,\"precipitation\":0.2512},{\"dt\":1703021040,\"precipitation\":0.2836},{\"dt\":1703021100,\"precipitation\":0.316},{\"dt\":1703021160,\"precipitation\":0.4026},{\"dt\":1703021220,\"precipitation\":0.4892},{\"dt\":1703021280,\"precipitation\":0.5758},{\"dt\":1703021340,\"precipitation\":0.6624},{\"dt\":1703021400,\"precipitation\":0.749},{\"dt\":1703021460,\"precipitation\":0.799},{\"dt\":1703021520,\"precipitation\":0.849},{\"dt\":1703021580,\"precipitation\":0.899},{\"dt\":1703021640,\"precipitation\":0.949},{\"dt\":1703021700,\"precipitation\":0.999},{\"dt\":1703021760,\"precipitation\":0.999},{\"dt\":1703021820,\"precipitation\":0.999},{\"dt\":1703021880,\"precipitation\":0.999},{\"dt\":1703021940,\"precipitation\":0.999},{\"dt\":1703022000,\"precipitation\":0.999},{\"dt\":1703022060,\"precipitation\":0.9722},{\"dt\":1703022120,\"precipitation\":0.9454},{\"dt\":1703022180,\"precipitation\":0.9186},{\"dt\":1703022240,\"precipitation\":0.8918},{\"dt\":1703022300,\"precipitation\":0.865},{\"dt\":1703022360,\"precipitation\":0.865},{\"dt\":1703022420,\"precipitation\":0.865},{\"dt\":1703022480,\"precipitation\":0.865},{\"dt\":1703022540,\"precipitation\":0.865},{\"dt\":1703022600,\"precipitation\":0.865},{\"dt\":1703022660,\"precipitation\":0.865},{\"dt\":1703022720,\"precipitation\":0.865},{\"dt\":1703022780,\"precipitation\":0.865},{\"dt\":1703022840,\"precipitation\":0.865},{\"dt\":1703022900,\"precipitation\":0.865},{\"dt\":1703022960,\"precipitation\":0.865},{\"dt\":1703023020,\"precipitation\":0.865},{\"dt\":1703023080,\"precipitation\":0.865},{\"dt\":1703023140,\"precipitation\":0.865},{\"dt\":1703023200,\"precipitation\":0.865},{\"dt\":1703023260,\"precipitation\":0.7762},{\"dt\":1703023320,\"precipitation\":0.6874},{\"dt\":1703023380,\"precipitation\":0.5986},{\"dt\":1703023440,\"precipitation\":0.5098},{\"dt\":1703023500,\"precipitation\":0.421},{\"dt\":1703023560,\"precipitation\":0.3634}],\"hourly\":[{\"dt\":1703019600,\"temp\":4.36,\"feels_like\":1.96,\"pressure\":1019,\"humidity\":81,\"dew_point\":1.39,\"uvi\":0,\"clouds\":75,\"visibility\":10000,\"wind_speed\":2.72,\"wind_deg\":213,\"wind_gust\":8.95,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":0.2,\"rain\":{\"1h\":0.32}},{\"dt\":1703023200,\"temp\":4.44,\"feels_like\":1.39,\"pressure\":1019,\"humidity\":78,\"dew_point\":0.94,\"uvi\":0,\"clouds\":79,\"visibility\":10000,\"wind_speed\":3.65,\"wind_deg\":217,\"wind_gust\":10.46,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":0.23,\"rain\":{\"1h\":0.87}},{\"dt\":1703026800,\"temp\":4.44,\"feels_like\":1.23,\"pressure\":1019,\"humidity\":79,\"dew_point\":1.12,\"uvi\":0,\"clouds\":83,\"visibility\":8414,\"wind_speed\":3.9,\"wind_deg\":214,\"wind_gust\":9.66,\"weather\":[{\"id\":803,\"main\":\"Clouds\",\"description\":\"Überwiegend bewölkt\",\"icon\":\"04n\"}],\"pop\":0.8},{\"dt\":1703030400,\"temp\":4.47,\"feels_like\":1.57,\"pressure\":1018,\"humidity\":84,\"dew_point\":2.01,\"uvi\":0,\"clouds\":88,\"visibility\":10000,\"wind_speed\":3.42,\"wind_deg\":215,\"wind_gust\":8.83,\"weather\":[{\"id\":501,\"main\":\"Rain\",\"description\":\"Mäßiger Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":1.36}},{\"dt\":1703034000,\"temp\":5.34,\"feels_like\":2.66,\"pressure\":1018,\"humidity\":87,\"dew_point\":3.35,\"uvi\":0,\"clouds\":95,\"visibility\":10000,\"wind_speed\":3.37,\"wind_deg\":244,\"wind_gust\":10.56,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":0.33}},{\"dt\":1703037600,\"temp\":6.31,\"feels_like\":3.08,\"pressure\":1018,\"humidity\":87,\"dew_point\":3.87,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.77,\"wind_deg\":260,\"wind_gust\":11.2,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":0.31}},{\"dt\":1703041200,\"temp\":6.03,\"feels_like\":2.62,\"pressure\":1018,\"humidity\":89,\"dew_point\":3.94,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":5.02,\"wind_deg\":264,\"wind_gust\":11.06,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":0.38}},{\"dt\":1703044800,\"temp\":5.7,\"feels_like\":2.24,\"pressure\":1018,\"humidity\":91,\"dew_point\":3.91,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.94,\"wind_deg\":265,\"wind_gust\":10.57,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":0.29}},{\"dt\":1703048400,\"temp\":5.77,\"feels_like\":2.51,\"pressure\":1019,\"humidity\":92,\"dew_point\":4.09,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.57,\"wind_deg\":265,\"wind_gust\":10.61,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0.8},{\"dt\":1703052000,\"temp\":5.65,\"feels_like\":2.6,\"pressure\":1019,\"humidity\":93,\"dew_point\":4.18,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.11,\"wind_deg\":251,\"wind_gust\":10.43,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0.8},{\"dt\":1703055600,\"temp\":5.7,\"feels_like\":2.43,\"pressure\":1020,\"humidity\":93,\"dew_point\":4.21,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.55,\"wind_deg\":248,\"wind_gust\":10.78,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":0.73,\"rain\":{\"1h\":0.11}},{\"dt\":1703059200,\"temp\":6.01,\"feels_like\":2.53,\"pressure\":1021,\"humidity\":85,\"dew_point\":3.32,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":5.16,\"wind_deg\":275,\"wind_gust\":10.29,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04d\"}],\"pop\":0.37},{\"dt\":1703062800,\"temp\":5.86,\"feels_like\":2.52,\"pressure\":1021,\"humidity\":80,\"dew_point\":2.28,\"uvi\":0.1,\"clouds\":94,\"visibility\":10000,\"wind_speed\":4.78,\"wind_deg\":275,\"wind_gust\":9.71,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04d\"}],\"pop\":0.15},{\"dt\":1703066400,\"temp\":5.82,\"feels_like\":2.53,\"pressure\":1021,\"humidity\":77,\"dew_point\":1.66,\"uvi\":0.11,\"clouds\":84,\"visibility\":10000,\"wind_speed\":4.65,\"wind_deg\":276,\"wind_gust\":9.68,\"weather\":[{\"id\":803,\"main\":\"Clouds\",\"description\":\"Überwiegend bewölkt\",\"icon\":\"04d\"}],\"pop\":0.07},{\"dt\":1703070000,\"temp\":5.2,\"feels_like\":1.79,\"pressure\":1021,\"humidity\":79,\"dew_point\":1.49,\"uvi\":0.19,\"clouds\":89,\"visibility\":10000,\"wind_speed\":4.58,\"wind_deg\":278,\"wind_gust\":9.8,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04d\"}],\"pop\":0.02},{\"dt\":1703073600,\"temp\":4.93,\"feels_like\":1.24,\"pressure\":1021,\"humidity\":79,\"dew_point\":1.08,\"uvi\":0.47,\"clouds\":90,\"visibility\":10000,\"wind_speed\":5.01,\"wind_deg\":266,\"wind_gust\":10.44,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04d\"}],\"pop\":0},{\"dt\":1703077200,\"temp\":5.13,\"feels_like\":1.53,\"pressure\":1020,\"humidity\":77,\"dew_point\":0.95,\"uvi\":0.54,\"clouds\":99,\"visibility\":10000,\"wind_speed\":4.93,\"wind_deg\":257,\"wind_gust\":10.04,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04d\"}],\"pop\":0},{\"dt\":1703080800,\"temp\":5.27,\"feels_like\":1.77,\"pressure\":1020,\"humidity\":74,\"dew_point\":0.49,\"uvi\":0.23,\"clouds\":99,\"visibility\":10000,\"wind_speed\":4.8,\"wind_deg\":256,\"wind_gust\":10.15,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04d\"}],\"pop\":0},{\"dt\":1703084400,\"temp\":5.07,\"feels_like\":1.53,\"pressure\":1020,\"humidity\":76,\"dew_point\":0.64,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.78,\"wind_deg\":254,\"wind_gust\":10.29,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04d\"}],\"pop\":0},{\"dt\":1703088000,\"temp\":4.91,\"feels_like\":1.43,\"pressure\":1020,\"humidity\":77,\"dew_point\":0.83,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.59,\"wind_deg\":240,\"wind_gust\":9.76,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0},{\"dt\":1703091600,\"temp\":4.76,\"feels_like\":1.08,\"pressure\":1020,\"humidity\":78,\"dew_point\":0.73,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.91,\"wind_deg\":239,\"wind_gust\":10.42,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0},{\"dt\":1703095200,\"temp\":4.71,\"feels_like\":1,\"pressure\":1020,\"humidity\":78,\"dew_point\":0.76,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":4.94,\"wind_deg\":241,\"wind_gust\":10.99,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0},{\"dt\":1703098800,\"temp\":4.67,\"feels_like\":0.82,\"pressure\":1019,\"humidity\":80,\"dew_point\":1.13,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":5.22,\"wind_deg\":238,\"wind_gust\":11.52,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0},{\"dt\":1703102400,\"temp\":4.56,\"feels_like\":0.6,\"pressure\":1019,\"humidity\":82,\"dew_point\":1.28,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":5.4,\"wind_deg\":235,\"wind_gust\":12.01,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0},{\"dt\":1703106000,\"temp\":4.34,\"feels_like\":0.3,\"pressure\":1018,\"humidity\":85,\"dew_point\":1.49,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":5.44,\"wind_deg\":232,\"wind_gust\":12.44,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0},{\"dt\":1703109600,\"temp\":4.7,\"feels_like\":0.67,\"pressure\":1017,\"humidity\":84,\"dew_point\":1.72,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":5.64,\"wind_deg\":234,\"wind_gust\":12.73,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0},{\"dt\":1703113200,\"temp\":5.03,\"feels_like\":0.87,\"pressure\":1017,\"humidity\":82,\"dew_point\":1.82,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":6.15,\"wind_deg\":237,\"wind_gust\":13.14,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0},{\"dt\":1703116800,\"temp\":4.37,\"feels_like\":0.05,\"pressure\":1016,\"humidity\":93,\"dew_point\":2.86,\"uvi\":0,\"clouds\":100,\"visibility\":7144,\"wind_speed\":6.12,\"wind_deg\":235,\"wind_gust\":13.47,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":0.2,\"rain\":{\"1h\":0.14}},{\"dt\":1703120400,\"temp\":4.55,\"feels_like\":0.32,\"pressure\":1015,\"humidity\":95,\"dew_point\":3.38,\"uvi\":0,\"clouds\":100,\"visibility\":2302,\"wind_speed\":6.02,\"wind_deg\":232,\"wind_gust\":13.62,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0.1},{\"dt\":1703124000,\"temp\":4.79,\"feels_like\":0.57,\"pressure\":1015,\"humidity\":96,\"dew_point\":3.74,\"uvi\":0,\"clouds\":100,\"visibility\":1612,\"wind_speed\":6.15,\"wind_deg\":229,\"wind_gust\":13.59,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0.03},{\"dt\":1703127600,\"temp\":5.08,\"feels_like\":0.82,\"pressure\":1014,\"humidity\":95,\"dew_point\":3.88,\"uvi\":0,\"clouds\":100,\"visibility\":6166,\"wind_speed\":6.45,\"wind_deg\":237,\"wind_gust\":14.77,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0.03},{\"dt\":1703131200,\"temp\":5.32,\"feels_like\":0.97,\"pressure\":1013,\"humidity\":93,\"dew_point\":3.81,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":6.88,\"wind_deg\":236,\"wind_gust\":15.18,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04n\"}],\"pop\":0.04},{\"dt\":1703134800,\"temp\":5.65,\"feels_like\":1.27,\"pressure\":1012,\"humidity\":93,\"dew_point\":4.18,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":7.24,\"wind_deg\":236,\"wind_gust\":15.05,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":0.2,\"rain\":{\"1h\":0.25}},{\"dt\":1703138400,\"temp\":5.88,\"feels_like\":1.51,\"pressure\":1012,\"humidity\":90,\"dew_point\":4,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":7.39,\"wind_deg\":236,\"wind_gust\":15.68,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":0.32,\"rain\":{\"1h\":0.14}},{\"dt\":1703142000,\"temp\":6.12,\"feels_like\":1.77,\"pressure\":1011,\"humidity\":90,\"dew_point\":4.18,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":7.54,\"wind_deg\":235,\"wind_gust\":15.67,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":0.39,\"rain\":{\"1h\":0.13}},{\"dt\":1703145600,\"temp\":6.47,\"feels_like\":2.26,\"pressure\":1011,\"humidity\":89,\"dew_point\":4.34,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":7.44,\"wind_deg\":237,\"wind_gust\":15.98,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"pop\":0.56,\"rain\":{\"1h\":0.12}},{\"dt\":1703149200,\"temp\":6.76,\"feels_like\":2.54,\"pressure\":1010,\"humidity\":89,\"dew_point\":4.55,\"uvi\":0.02,\"clouds\":100,\"visibility\":10000,\"wind_speed\":7.73,\"wind_deg\":235,\"wind_gust\":16.35,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"pop\":0.83,\"rain\":{\"1h\":0.22}},{\"dt\":1703152800,\"temp\":7.16,\"feels_like\":2.99,\"pressure\":1009,\"humidity\":86,\"dew_point\":4.48,\"uvi\":0.05,\"clouds\":100,\"visibility\":10000,\"wind_speed\":7.98,\"wind_deg\":235,\"wind_gust\":16.39,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"pop\":0.72,\"rain\":{\"1h\":0.14}},{\"dt\":1703156400,\"temp\":7.61,\"feels_like\":3.5,\"pressure\":1008,\"humidity\":84,\"dew_point\":4.58,\"uvi\":0.08,\"clouds\":100,\"visibility\":10000,\"wind_speed\":8.22,\"wind_deg\":240,\"wind_gust\":17.9,\"weather\":[{\"id\":804,\"main\":\"Clouds\",\"description\":\"Bedeckt\",\"icon\":\"04d\"}],\"pop\":0.6},{\"dt\":1703160000,\"temp\":7.8,\"feels_like\":3.68,\"pressure\":1007,\"humidity\":84,\"dew_point\":4.82,\"uvi\":0.12,\"clouds\":100,\"visibility\":10000,\"wind_speed\":8.49,\"wind_deg\":242,\"wind_gust\":18.99,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"pop\":0.94,\"rain\":{\"1h\":0.26}},{\"dt\":1703163600,\"temp\":7.94,\"feels_like\":3.72,\"pressure\":1005,\"humidity\":84,\"dew_point\":4.86,\"uvi\":0.05,\"clouds\":100,\"visibility\":10000,\"wind_speed\":9.02,\"wind_deg\":244,\"wind_gust\":19.79,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"pop\":0.95,\"rain\":{\"1h\":0.24}},{\"dt\":1703167200,\"temp\":7.9,\"feels_like\":3.62,\"pressure\":1004,\"humidity\":84,\"dew_point\":4.88,\"uvi\":0.02,\"clouds\":100,\"visibility\":10000,\"wind_speed\":9.21,\"wind_deg\":244,\"wind_gust\":20.46,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"pop\":1,\"rain\":{\"1h\":0.52}},{\"dt\":1703170800,\"temp\":8.11,\"feels_like\":3.82,\"pressure\":1004,\"humidity\":83,\"dew_point\":4.89,\"uvi\":0,\"clouds\":100,\"visibility\":8398,\"wind_speed\":9.52,\"wind_deg\":249,\"wind_gust\":20.42,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"pop\":1,\"rain\":{\"1h\":0.8}},{\"dt\":1703174400,\"temp\":8.24,\"feels_like\":3.95,\"pressure\":1004,\"humidity\":83,\"dew_point\":5.08,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":9.69,\"wind_deg\":246,\"wind_gust\":20.15,\"weather\":[{\"id\":501,\"main\":\"Rain\",\"description\":\"Mäßiger Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":1.17}},{\"dt\":1703178000,\"temp\":8.76,\"feels_like\":4.79,\"pressure\":1003,\"humidity\":83,\"dew_point\":5.52,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":9.06,\"wind_deg\":250,\"wind_gust\":19.48,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":0.5}},{\"dt\":1703181600,\"temp\":9.36,\"feels_like\":5.64,\"pressure\":1003,\"humidity\":85,\"dew_point\":6.54,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":8.79,\"wind_deg\":259,\"wind_gust\":17.63,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":0.44}},{\"dt\":1703185200,\"temp\":9.64,\"feels_like\":5.86,\"pressure\":1004,\"humidity\":86,\"dew_point\":6.92,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":9.43,\"wind_deg\":266,\"wind_gust\":17.56,\"weather\":[{\"id\":501,\"main\":\"Rain\",\"description\":\"Mäßiger Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":1.08}},{\"dt\":1703188800,\"temp\":9.54,\"feels_like\":5.97,\"pressure\":1004,\"humidity\":86,\"dew_point\":6.85,\"uvi\":0,\"clouds\":100,\"visibility\":10000,\"wind_speed\":8.42,\"wind_deg\":263,\"wind_gust\":16.89,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10n\"}],\"pop\":1,\"rain\":{\"1h\":0.55}}],\"daily\":[{\"dt\":1702983600,\"sunrise\":1702969900,\"sunset\":1702999624,\"moonrise\":1702985640,\"moonset\":0,\"moon_phase\":0.25,\"summary\":\"Expect a day of partly cloudy with rain\",\"temp\":{\"day\":6.16,\"min\":1.72,\"max\":6.16,\"night\":4.44,\"eve\":3.3,\"morn\":2.03},\"feels_like\":{\"day\":6.16,\"night\":1.39,\"eve\":3.3,\"morn\":2.03},\"pressure\":1027,\"humidity\":56,\"dew_point\":-2.31,\"wind_speed\":3.65,\"wind_deg\":217,\"wind_gust\":10.46,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"clouds\":56,\"pop\":0.23,\"rain\":1.19,\"uvi\":0.83},{\"dt\":1703070000,\"sunrise\":1703056336,\"sunset\":1703086046,\"moonrise\":1703073000,\"moonset\":1703028300,\"moon_phase\":0.27,\"summary\":\"Expect a day of partly cloudy with rain\",\"temp\":{\"day\":5.2,\"min\":4.34,\"max\":6.31,\"night\":4.7,\"eve\":4.76,\"morn\":5.77},\"feels_like\":{\"day\":1.79,\"night\":0.67,\"eve\":1.08,\"morn\":2.51},\"pressure\":1021,\"humidity\":79,\"dew_point\":1.49,\"wind_speed\":5.64,\"wind_deg\":234,\"wind_gust\":12.73,\"weather\":[{\"id\":501,\"main\":\"Rain\",\"description\":\"Mäßiger Regen\",\"icon\":\"10d\"}],\"clouds\":89,\"pop\":1,\"rain\":2.78,\"uvi\":0.54},{\"dt\":1703156400,\"sunrise\":1703142769,\"sunset\":1703172470,\"moonrise\":1703160360,\"moonset\":1703119500,\"moon_phase\":0.31,\"summary\":\"Expect a day of partly cloudy with rain\",\"temp\":{\"day\":7.61,\"min\":4.37,\"max\":9.64,\"night\":8.8,\"eve\":8.76,\"morn\":5.65},\"feels_like\":{\"day\":3.5,\"night\":5.23,\"eve\":4.79,\"morn\":1.27},\"pressure\":1008,\"humidity\":84,\"dew_point\":4.58,\"wind_speed\":9.69,\"wind_deg\":246,\"wind_gust\":20.46,\"weather\":[{\"id\":501,\"main\":\"Rain\",\"description\":\"Mäßiger Regen\",\"icon\":\"10d\"}],\"clouds\":100,\"pop\":1,\"rain\":8.91,\"uvi\":0.12},{\"dt\":1703242800,\"sunrise\":1703229199,\"sunset\":1703258898,\"moonrise\":1703247780,\"moonset\":1703210700,\"moon_phase\":0.35,\"summary\":\"Expect a day of partly cloudy with rain\",\"temp\":{\"day\":8.61,\"min\":6.92,\"max\":9.29,\"night\":6.92,\"eve\":7.61,\"morn\":7.69},\"feels_like\":{\"day\":4.67,\"night\":2.7,\"eve\":3.38,\"morn\":3.85},\"pressure\":1008,\"humidity\":68,\"dew_point\":2.77,\"wind_speed\":10.92,\"wind_deg\":271,\"wind_gust\":24.29,\"weather\":[{\"id\":501,\"main\":\"Rain\",\"description\":\"Mäßiger Regen\",\"icon\":\"10d\"}],\"clouds\":100,\"pop\":1,\"rain\":8.96,\"uvi\":0.66},{\"dt\":1703329200,\"sunrise\":1703315627,\"sunset\":1703345328,\"moonrise\":1703335440,\"moonset\":1703301900,\"moon_phase\":0.38,\"summary\":\"Expect a day of partly cloudy with rain\",\"temp\":{\"day\":7.81,\"min\":7.57,\"max\":8.67,\"night\":8.67,\"eve\":8.19,\"morn\":8.05},\"feels_like\":{\"day\":3.85,\"night\":5.25,\"eve\":4.62,\"morn\":4.2},\"pressure\":1016,\"humidity\":75,\"dew_point\":3.15,\"wind_speed\":8.6,\"wind_deg\":264,\"wind_gust\":17.57,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"clouds\":100,\"pop\":0.55,\"rain\":0.8,\"uvi\":0.35},{\"dt\":1703415600,\"sunrise\":1703402052,\"sunset\":1703431761,\"moonrise\":1703423400,\"moonset\":1703393160,\"moon_phase\":0.41,\"summary\":\"Expect a day of partly cloudy with rain\",\"temp\":{\"day\":9.28,\"min\":8.35,\"max\":10.84,\"night\":10.84,\"eve\":9.59,\"morn\":8.39},\"feels_like\":{\"day\":6.12,\"night\":10.09,\"eve\":6.89,\"morn\":4.52},\"pressure\":1015,\"humidity\":78,\"dew_point\":5.21,\"wind_speed\":8.23,\"wind_deg\":232,\"wind_gust\":17.61,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"clouds\":100,\"pop\":0.99,\"rain\":1.76,\"uvi\":0.17},{\"dt\":1703502000,\"sunrise\":1703488473,\"sunset\":1703518197,\"moonrise\":1703511960,\"moonset\":1703484180,\"moon_phase\":0.45,\"summary\":\"Expect a day of partly cloudy with rain\",\"temp\":{\"day\":11.09,\"min\":9.73,\"max\":11.09,\"night\":10.05,\"eve\":10.26,\"morn\":10.58},\"feels_like\":{\"day\":10.21,\"night\":9.38,\"eve\":9.56,\"morn\":9.44},\"pressure\":1015,\"humidity\":75,\"dew_point\":6.38,\"wind_speed\":5.53,\"wind_deg\":246,\"wind_gust\":14.89,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"clouds\":100,\"pop\":1,\"rain\":0.42,\"uvi\":1},{\"dt\":1703588400,\"sunrise\":1703574892,\"sunset\":1703604636,\"moonrise\":1703601120,\"moonset\":1703574720,\"moon_phase\":0.48,\"summary\":\"There will be rain today\",\"temp\":{\"day\":5.45,\"min\":5.01,\"max\":9.89,\"night\":5.01,\"eve\":5.12,\"morn\":8.07},\"feels_like\":{\"day\":3.59,\"night\":5.01,\"eve\":5.12,\"morn\":7.48},\"pressure\":1019,\"humidity\":91,\"dew_point\":3.76,\"wind_speed\":2.94,\"wind_deg\":256,\"wind_gust\":8.15,\"weather\":[{\"id\":500,\"main\":\"Rain\",\"description\":\"Leichter Regen\",\"icon\":\"10d\"}],\"clouds\":100,\"pop\":1,\"rain\":3.18,\"uvi\":1}],\"alerts\":[{\"sender_name\":\"Deutscher Wetterdienst\",\"event\":\"icy surfaces\",\"start\":1703012400,\"end\":1703037600,\"description\":\"There is a slight risk of icy surfaces (Level 1 of 4).\",\"tags\":[\"Other dangers\"]},{\"sender_name\":\"Deutscher Wetterdienst\",\"event\":\"frost\",\"start\":1703012400,\"end\":1703037600,\"description\":\"There is a risk of frost (Level 1 of 2).\nMinimum temperature: ~ -1 °C\",\"tags\":[\"Extreme temperature value\"]}]}";
#endif// __TEST__

bool WifiParser::setup() 
{
  WiFi.begin(ssid, password);
  Serial.println("Connecting: " + String(ssid) + ", " + String(password));
  int i=0;
  while(WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print("." + String(++i));
  }

  Serial.println("");
  Serial.println("Wifi::status: " + String(WiFi.status()));
  Serial.print("Connected to WiFi network with IP Address: ");
  Serial.println(WiFi.localIP());

  return true;
}

bool WifiParser::parse(JsonStreamingParser* pParser)
{
  Serial.println("Start parsing...");
  
  #ifdef __TEST__
    int i = 0;
    while (testResponse[i] != '\0')
    {
        pParser->parse(testResponse[i++]);
    }
    return true;
  #endif// __TEST__

  bool ok(true);
  String oneCallWheaterRequest = String("http://api.openweathermap.org/data/3.0/onecall")
           + "?lat=" + lat + "&lon=" + lon + "&appid=" + appid + "&units=" + units + "&lang=" + lang;

  //String oneCallWheaterRequest = String("http://api.openweathermap.org/data/2.5/weather")
  //        + "?lat=" + lat + "&lon=" + lon + "&appid=" + appid + "&units=" + units + "&lang=" + lang;

  if ((millis() - lastTime) > timerDelay)
  {
    Serial.println(oneCallWheaterRequest);

    // Check WiFi connection status
    if(WiFi.status()== WL_CONNECTED)
    {    
      ok = httpGETRequest(oneCallWheaterRequest.c_str(), pParser);
    }
    else 
    {
      Serial.println("WiFi Disconnected");
    }
    lastTime = millis();
  }

  return ok;
}

bool WifiParser::httpGETRequest(const char* szRequest, JsonStreamingParser* pParser) 
{
  bool ok(true);

  WiFiClient client;
  HTTPClient http;
    
  // Your Domain name with URL path or IP address with path
  Serial.println("http.begin");
  http.begin(client, szRequest);
  
  // Send HTTP POST request
  Serial.println("http.GET");
  int httpResponseCode = http.GET();
  
  WiFiClient* pClientStream;

  if (httpResponseCode > 0) 
  {
    Serial.print("HTTP Response code: ");
    Serial.println(httpResponseCode);

    pClientStream = http.getStreamPtr();

    Serial.printf("length: %d\n", http.getSize());

    while (pClientStream && pClientStream->available())
    {
      char c = pClientStream->read();
      Serial.print(c);
      pParser->parse(c);

      yield();//give the stream a chance to read the next character
    }
    unsigned int availableRemaining = pClientStream->available();
    if (availableRemaining > 0)
    {
      availableRemainingCounter++;
    }
    Serial.printf("\nStream is available: %d, is null %d times\n", availableRemaining, availableRemainingCounter);

    Serial.flush();
    Serial.println("done read");
  }
  else {
    Serial.print("Error code: ");
    Serial.println(httpResponseCode);

    ok = false;
  }
  // Free resources
  http.end();

  Serial.println("waiting for next call\n-------------");

  return ok;
}